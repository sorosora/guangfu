name: Generate Tiles (Production Minimal v2.0)

on:
  schedule:
    # æ¯ 5 åˆ†é˜åŸ·è¡Œä¸€æ¬¡ - æ¥µç°¡æ¶æ§‹èƒ½åœ¨ 150 åˆ†é˜/æœˆå…§åŸ·è¡Œ
    - cron: '*/5 * * * *'
  workflow_dispatch:
    # å…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      force_regenerate:
        description: 'å¼·åˆ¶é‡æ–°ç”Ÿæˆæ‰€æœ‰åœ–ç£š'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-tiles:
    runs-on: ubuntu-latest
    timeout-minutes: 5 # æ¥µç°¡æ¶æ§‹ <2 ç§’ï¼Œè¨­å®š 5 åˆ†é˜è¶…æ™‚ä¿è­·

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: tiles-deps-${{ runner.os }}-py3.11-${{ hashFiles('scripts/generate_tiles.py') }}
          restore-keys: |
            tiles-deps-${{ runner.os }}-py3.11-

      - name: Install optimized dependencies
        run: |
          python -m pip install --upgrade pip
          # æ¥µç°¡ä¾è³´åˆ—è¡¨ - å°ˆç‚ºç”Ÿç”¢ç’°å¢ƒå„ªåŒ–
          # æ³¨æ„ï¼šcertifi ç‰ˆæœ¬é–å®šé¿å… SSL å•é¡Œ
          pip install --no-cache-dir pillow>=10.0.0 numpy>=1.24.0 requests>=2.31.0 boto3>=1.29.0 urllib3>=2.0.0 certifi==2024.8.30

      - name: Validate environment
        run: |
          echo "ğŸ” é©—è­‰åŸ·è¡Œç’°å¢ƒ..."
          python --version
          python -c "import PIL, numpy, requests, boto3, certifi; print(f'âœ… æ‰€æœ‰ä¾è³´æ­£å¸¸'); print(f'ğŸ“¦ certifi: {certifi.__version__}'); print(f'ğŸ“¦ boto3: {boto3.__version__}')"
          echo "â° åŸ·è¡Œæ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          # é©—è­‰é—œéµç’°å¢ƒè®Šæ•¸
          echo "ğŸ”§ é©—è­‰ç’°å¢ƒè®Šæ•¸..."
          if [ -z "$CLOUDFLARE_R2_ENDPOINTS" ]; then
            echo "âš ï¸ è­¦å‘Š: CLOUDFLARE_R2_ENDPOINTS æœªè¨­å®š"
          else
            echo "âœ… R2 ç«¯é»: $CLOUDFLARE_R2_ENDPOINTS"
          fi

      - name: Execute minimal tile generation
        env:
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
          CLOUDFLARE_R2_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_R2_ACCESS_KEY_ID }}
          CLOUDFLARE_R2_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_R2_SECRET_ACCESS_KEY }}
          CLOUDFLARE_R2_BUCKET_NAME: ${{ secrets.CLOUDFLARE_R2_BUCKET_NAME }}
          CLOUDFLARE_R2_ENDPOINTS: ${{ secrets.CLOUDFLARE_R2_ENDPOINTS }}
          # å¤šå€åŸŸåœ–ç£šç”Ÿæˆé…ç½®
          TILE_GENERATION_AREAS: ${{ vars.TILE_GENERATION_AREAS || 'guangfu' }}
        run: |
          echo "ğŸš€ å•Ÿå‹•å¤šå€åŸŸåœ–ç£šç”Ÿæˆå™¨ v3.1"
          echo "ğŸŒ å•Ÿç”¨å€åŸŸ: ${TILE_GENERATION_AREAS:-guangfu}"
          start_time=$(date +%s)

          # åŸ·è¡Œå¤šå€åŸŸåœ–ç£šç”Ÿæˆ
          python scripts/generate_tiles.py

          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "â±ï¸ ç¸½åŸ·è¡Œæ™‚é–“: ${duration} ç§’"
          echo "ğŸ’° æœ¬æ¬¡æ¶ˆè€—: $(echo "scale=2; $duration/60" | bc) åˆ†é˜"

      - name: Performance monitoring
        if: always()
        run: |
          echo "ğŸ“Š === åŸ·è¡Œçµ±è¨ˆ ==="
          echo "æ—¥æœŸ: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "åŸ·è¡Œå™¨: ${{ runner.os }}"
          echo "Python ç‰ˆæœ¬: $(python --version)"

          # æª¢æŸ¥ç³»çµ±è³‡æºä½¿ç”¨
          if command -v free >/dev/null 2>&1; then
            echo "è¨˜æ†¶é«”ä½¿ç”¨: $(free -h | grep '^Mem:' | awk '{print $3"/"$2}')"
          fi

          # æª¢æŸ¥ç£ç¢Ÿä½¿ç”¨
          echo "ç£ç¢Ÿä½¿ç”¨: $(df -h / | tail -1 | awk '{print $3"/"$2" ("$5")"}')"

      - name: Budget tracking
        if: always()
        run: |
          echo "ğŸ’° === é ç®—è¿½è¹¤ ==="
          echo "ç›®æ¨™: æ¯æœˆ <2000 åˆ†é˜"
          echo "é »ç‡: æ¯ 5 åˆ†é˜åŸ·è¡Œ"
          echo "æ¯æœˆåŸ·è¡Œæ¬¡æ•¸: 8640 æ¬¡"
          echo "é æœŸæ¯æ¬¡åŸ·è¡Œ: <2 ç§’"
          echo "é æœŸæ¯æœˆç¸½æ™‚é–“: <288 åˆ†é˜"
          echo "å¯¦éš›åŸ·è¡Œè«‹æŸ¥çœ‹ä¸Šæ–¹ 'ç¸½åŸ·è¡Œæ™‚é–“'"

      - name: Error handling and notification
        if: failure()
        run: |
          echo "âŒ === åŸ·è¡Œå¤±æ•— ==="
          echo "æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "è«‹æª¢æŸ¥:"
          echo "1. Redis é€£ç·šç‹€æ…‹ (UPSTASH_REDIS_REST_URL)"
          echo "2. R2 æ†‘è­‰é…ç½® (CLOUDFLARE_R2_ACCESS_KEY_ID, CLOUDFLARE_R2_SECRET_ACCESS_KEY)"
          echo "3. R2 ç«¯é»é…ç½® (CLOUDFLARE_R2_ENDPOINTS)"
          echo "4. ç¶²æ ¼è®Šæ›´æ˜¯å¦å­˜åœ¨ (changed_grids)"
          echo "5. SSL/TLS æ†‘è­‰å•é¡Œ (certifi ç‰ˆæœ¬)"
          echo "6. ç³»çµ±è³‡æºæ˜¯å¦å……è¶³"

          # åŸºæœ¬é€£ç·šæ¸¬è©¦
          echo ""
          echo "ğŸ” === åŸºæœ¬è¨ºæ–· ==="
          if [ ! -z "$CLOUDFLARE_R2_ENDPOINTS" ]; then
            echo "æ¸¬è©¦ R2 ç«¯é»é€£ç·š..."
            curl -I "$CLOUDFLARE_R2_ENDPOINTS" || echo "R2 ç«¯é»ç„¡æ³•è¨ªå•"
          fi

          if [ ! -z "$UPSTASH_REDIS_REST_URL" ]; then
            echo "æ¸¬è©¦ Redis ç«¯é»é€£ç·š..."
            curl -I "$UPSTASH_REDIS_REST_URL" || echo "Redis ç«¯é»ç„¡æ³•è¨ªå•"
          fi

          exit 1

      - name: Success summary
        if: success()
        run: |
          echo "âœ… === åŸ·è¡ŒæˆåŠŸ ==="
          echo "æ¥µç°¡æ¶æ§‹æ­£å¸¸é‹ä½œ"
          echo "åœ–ç£šå·²æ›´æ–°åˆ°æœ€æ–°ç‹€æ…‹"
          echo "ä¸‹æ¬¡åŸ·è¡Œ: 5 åˆ†é˜å¾Œ"
