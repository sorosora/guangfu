# 圖磚格線問題技術分析報告

**發現日期：** 2025年10月4日  
**狀態：** 已確認，待修復  
**優先級：** 高  
**影響範圍：** 圖磚生成系統

---

## 📋 問題描述

### 現象

在單點回報產生的範圍效應圖磚中，25公尺半徑內的區域呈現明顯的格線狀分布，而非預期的平滑圓形。

### 視覺證據

- 範圍效應產生約 17-18 個座標點
- 這些點在圖磚上呈現規律的網格排列
- 圓形內部有明顯的空白區域
- 格線間距約為 11.1 公尺

## 🔍 根本原因分析

### 技術原因

問題源於 **4 decimal 精度座標系統** 的離散化特性：

1. **座標精度限制**
   - 4 decimal 精度：0.0001° ≈ 11.1 公尺
   - 範圍效應半徑：25 公尺
   - 圓形半徑僅覆蓋約 2.3 個網格步長

2. **範圍效應算法**

   ```python
   # 離散網格掃描
   coord_step = 1 / (10 ** 4)  # 0.0001 度
   for lat_offset in range(-lat_steps, lat_steps + 1):
       for lon_offset in range(-lon_steps, lon_steps + 1):
           test_lat = lat + (lat_offset * coord_step)
           test_lon = lon + (lon_offset * coord_step)
   ```

3. **空間分布問題**
   - 算法在矩形網格中搜尋圓形範圍
   - 網格點間距過大，導致圓形內部出現空隙
   - 離散點排列呈現規律的網格狀模式

### 實驗數據

測試座標：(23.6715, 121.4355)，半徑 25 公尺

```
=== 座標點在 25m 圓形內的分布 ===
    -2-1 0 1 2
 2:  · ● ● ● ·
 1:  ● ● ● ● ●
 0:  ● ● + ● ●
-1:  ● ● ● ● ●
-2:  · ● ● ● ·

說明:
+ = 中心點
● = 在 25m 半徑內的座標點 (21個)
· = 網格點但超出 25m 半徑
```

**分析結果：**

- 產生 21 個座標點
- 網格間距：11.1 公尺
- 四個角落點距離約 24.5-24.9 公尺
- 圓形內部存在明顯空隙

## 🎯 解決方案分析

### 選項 1：提高座標精度（推薦）

**做法：** 從 4 decimal 改為 5 或 6 decimal

- **5 decimal (0.00001°)：** ~1.1 公尺精度
- **6 decimal (0.000001°)：** ~0.11 公尺精度

**優點：**

- 根本解決精度不足問題
- 圓形效果更平滑自然
- 數據精度提升

**缺點：**

- 座標點數量大幅增加（可能增至 100+ 點）
- Redis 儲存空間增加
- 計算複雜度提升

### 選項 2：調整範圍效應參數

**做法：** 修改範圍半徑或限制最大座標數

**2a. 增加範圍半徑至 40-50 公尺**

- 優點：獲得更多座標點，分布更均勻
- 缺點：可能影響信任演算法的準確性

**2b. 減少範圍半徑至 15-20 公尺**

- 優點：減少空隙，更緊密的圓形
- 缺點：範圍效應覆蓋範圍縮小

### 選項 3：圖磚生成時插值處理

**做法：** 在生成圖磚時對空隙區域進行插值填補

**優點：**

- 不改變現有座標系統
- 視覺效果改善
- 保持計算效率

**缺點：**

- 增加圖磚生成複雜度
- 可能混淆真實數據的精確性
- 插值算法需要精心設計

### 選項 4：接受現狀（不推薦）

**理由：** 認為網格狀分布反映系統真實精度

**問題：**

- 用戶體驗不佳
- 圓形內空白區域實際上應該受到影響
- 不符合範圍效應的語義預期

## 📊 影響評估

### 對用戶體驗的影響

- **視覺混亂：** 格線效果看起來像是系統錯誤
- **信任度影響：** 可能降低用戶對系統準確性的信任
- **功能理解：** 用戶可能不理解為什麼圓形內有空白

### 對數據準確性的影響

- **覆蓋不完整：** 25 公尺範圍內的部分區域未被標記
- **效應不均勻：** 範圍效應分布不符合地理直覺
- **算法偏差：** 離散化導致的系統性偏差

### 對系統效能的影響

- **當前狀況：** 每次回報產生 21 個座標點
- **5 decimal 升級：** 可能增至 100+ 點（+400%）
- **6 decimal 升級：** 可能增至 1000+ 點（+4000%）

## 💡 建議解決路徑

### 短期解決方案（階段六）

1. **調整範圍效應參數**
   - 測試 30-35 公尺半徑的效果
   - 或者將精度臨時提升至 5 decimal
   - 在不影響系統穩定性的前提下改善視覺效果

### 中期解決方案（後續版本）

1. **實作 5 decimal 精度系統**
   - 完整測試效能影響
   - 優化 Redis 儲存和查詢
   - 確保圖磚生成效率

### 長期解決方案（未來考慮）

1. **混合精度系統**
   - 核心區域使用高精度
   - 邊緣區域使用標準精度
   - 動態調整精度策略

## 🔧 技術實作細節

### 快速測試不同精度

```python
# 測試精度影響
for precision in [4, 5, 6]:
    coords = get_geo_radius_coords(lat, lon, 25, precision=precision)
    print(f'精度 {precision}: {len(coords)} 個座標點')
```

### 範圍效應優化

```python
# 可能的優化方向
def get_optimized_radius_coords(lat, lon, radius_meters, precision=4):
    # 1. 動態調整搜尋範圍
    # 2. 加入亞像素插值
    # 3. 實作圓形邊界平滑化
    pass
```

## 📅 修復時程規劃

### 階段六（上線前）

- [ ] 實作範圍半徑調整測試
- [ ] 評估 5 decimal 精度的可行性
- [ ] 選擇並實作臨時解決方案

### 階段七（上線後）

- [ ] 根據生產環境回饋調整策略
- [ ] 實作長期解決方案
- [ ] 完善用戶體驗優化

## 📚 相關檔案

- `scripts/utils/coordinate_utils.py:242` - 範圍效應算法實作
- `scripts/generate_tiles.py:237` - 圖磚生成邏輯
- `src/lib/geo-coordinates.ts:115` - 前端範圍效應計算
- `src/app/api/report/route.ts:59` - API 範圍效應處理

## 📝 備註

此問題突顯了離散座標系統在表示連續地理現象時的固有限制。解決方案需要在數據精度、計算效率和用戶體驗之間取得平衡。

---

**文件建立：** 2025年10月4日  
**最後更新：** 2025年10月4日  
**負責人：** TMS 標準化小組
